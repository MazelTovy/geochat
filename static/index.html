<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeepSeek-R1 Chat with NYC Schools Data</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <!-- Add Marked.js for Markdown rendering -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- Add Highlight.js for syntax highlighting in code blocks -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/styles/github.min.css">
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/highlight.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
        }
        .chat-container {
            height: 500px;
            overflow-y: auto;
            padding: 20px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .message {
            margin-bottom: 15px;
            padding: 10px 15px;
            border-radius: 18px;
            max-width: 80%;
            position: relative;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        .user-message {
            background-color: #dcf8c6;
            margin-left: auto;
            border-top-right-radius: 5px;
            text-align: right;
            float: right;
            clear: both;
        }
        .assistant-message {
            background-color: #f1f0f0;
            margin-right: auto;
            border-top-left-radius: 5px;
            text-align: left;
            float: left;
            clear: both;
        }
        .message-wrapper {
            width: 100%;
            display: inline-block;
            margin-bottom: 10px;
            overflow: hidden;
        }
        .thinking {
            font-size: 0.9em;
            background-color: #f8f4e3;
            border-left: 3px solid #ffd700;
            padding: 10px;
            margin-top: 10px;
            border-radius: 5px;
            display: none;
            clear: both;
        }
        .message-text {
            word-wrap: break-word;
        }
        .message-header {
            font-weight: bold;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
        }
        .message-header i {
            margin-right: 5px;
        }
        #connection-status {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 5px 10px;
            border-radius: 5px;
            font-weight: bold;
            z-index: 1000;
            font-size: 0.8rem;
            max-width: 150px;
            background-color: rgba(255, 255, 255, 0.9);
        }
        .connected {
            background-color: #d4edda;
            color: #155724;
        }
        .disconnected {
            background-color: #f8d7da;
            color: #721c24;
        }
        .send-button {
            background-color: #5cb85c;
            border-color: #5cb85c;
        }
        .send-button:hover {
            background-color: #4cae4c;
            border-color: #4cae4c;
        }
        .debug-panel {
            background-color: #343a40;
            color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-top: 15px;
            display: none;
        }
        .loader {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(0,0,0,.1);
            border-radius: 50%;
            border-top-color: #767676;
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        table, th, td {
            border: 1px solid #ddd;
        }
        th, td {
            padding: 10px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        blockquote {
            border-left: 3px solid #ccc;
            margin-left: 5px;
            padding-left: 15px;
            color: #666;
        }
        pre {
            background-color: #f6f8fa;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
        }
        code {
            font-family: 'Courier New', monospace;
            background-color: #f6f8fa;
            padding: 2px 4px;
            border-radius: 3px;
        }
        pre code {
            background-color: transparent;
            padding: 0;
        }
        .toggle-thinking {
            font-size: 0.8em;
            color: #007bff;
            cursor: pointer;
            margin-top: 5px;
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <div class="row">
            <div class="col-md-10 text-center">
                <h1><i class="bi bi-robot"></i> DeepSeek-R1 Chat</h1>
                <p class="text-muted">Powered by NYU NYC Schools Data</p>
            </div>
            <div class="col-md-2 d-flex align-items-center justify-content-end">
                <div id="connection-status">Checking connection...</div>
            </div>
        </div>

        <div class="row mt-3">
            <div class="col-md-12">
                <div class="chat-container" id="chat-container">
                    <!-- Messages will be displayed here -->
                </div>
            </div>
        </div>

        <div class="row mt-3">
            <div class="col-md-12">
                <div class="input-group">
                    <textarea id="user-input" class="form-control" placeholder="Type your message here..." rows="2"></textarea>
                    <button class="btn send-button" id="send-button">
                        <i class="bi bi-send-fill"></i> Send
                    </button>
                </div>
                <div class="form-check mt-2">
                    <input class="form-check-input" type="checkbox" id="use-retrieval" checked>
                    <label class="form-check-label" for="use-retrieval">
                        Use NYC Schools Knowledge Base
                    </label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="show-thinking">
                    <label class="form-check-label" for="show-thinking">
                        Show AI Thinking Process
                    </label>
                </div>
            </div>
        </div>

        <div id="debug-panel" class="debug-panel">
            <h5>Debug Information</h5>
            <div id="debug-info"></div>
        </div>
    </div>

    <script>
        // API endpoints
        const API_URL = 'http://localhost:8000/api';  // Use explicit localhost for development
        const CHAT_ENDPOINT = `${API_URL}/chat`;
        const HEALTH_ENDPOINT = `${API_URL}/health`;
        
        // DOM elements
        const chatContainer = document.getElementById('chat-container');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        const connectionStatus = document.getElementById('connection-status');
        const useRetrieval = document.getElementById('use-retrieval');
        const showThinking = document.getElementById('show-thinking');
        const debugPanel = document.getElementById('debug-panel');
        const debugInfo = document.getElementById('debug-info');
        
        // Chat history
        let chatHistory = [];
        
        // Initialize the chat
        async function initChat() {
            try {
                chatHistory = [];
                
                // Add initial assistant message
                addMessage({
                    role: 'assistant',
                    content: "Hello! I'm an AI assistant powered by DeepSeek-R1. How can I help you today?"
                });
                
                // Check connection to the API
                await checkConnection();
                
                // Set up periodic connection checking
                setInterval(checkConnection, 15000);
                
                // Initialize textarea height
                userInput.style.height = 'auto';
                userInput.style.height = (userInput.scrollHeight) + 'px';
                
                // Enable send button and input
                sendButton.disabled = false;
                userInput.disabled = false;
            } catch (error) {
                console.error('Error initializing chat:', error);
                connectionStatus.textContent = 'Connection Error';
                connectionStatus.className = 'disconnected';
            }
        }
        
        // Check connection to the API
        async function checkConnection() {
            try {
                const response = await fetch(HEALTH_ENDPOINT);
                const data = await response.json();
                
                if (response.ok) {
                    connectionStatus.textContent = 'Connected';
                    connectionStatus.className = 'connected';
                    
                    // Add debug info
                    const debugData = `Model loaded: ${data.model_loaded}, RAG enabled: ${data.retrieval_ready}, Device: ${data.device}`;
                    debugInfo.textContent = debugData;
                    
                    // Enable send button and input if connected
                    sendButton.disabled = false;
                    userInput.disabled = false;
                } else {
                    connectionStatus.textContent = 'API Error';
                    connectionStatus.className = 'disconnected';
                    sendButton.disabled = true;
                    userInput.disabled = true;
                }
            } catch (error) {
                connectionStatus.textContent = 'Disconnected';
                connectionStatus.className = 'disconnected';
                sendButton.disabled = true;
                userInput.disabled = true;
                console.error('Error checking connection:', error);
            }
        }
        
        // Add a message to the chat
        function addMessage(message) {
            // Create message wrapper
            const messageWrapper = document.createElement('div');
            messageWrapper.className = 'message-wrapper';
            
            // Create message element
            const messageElement = document.createElement('div');
            messageElement.className = `message ${message.role}-message`;
            
            // Add header with icon
            const headerElement = document.createElement('div');
            headerElement.className = 'message-header';
            
            if (message.role === 'user') {
                headerElement.innerHTML = '<i class="bi bi-person-circle"></i> You';
            } else {
                headerElement.innerHTML = '<i class="bi bi-robot"></i> Assistant';
            }
            
            messageElement.appendChild(headerElement);
            
            // Add message text with markdown rendering
            const textElement = document.createElement('div');
            textElement.className = 'message-text';
            
            // Process content to remove special tokens
            let processedContent = message.content;
            if (message.role === 'assistant') {
                processedContent = cleanSpecialTokens(processedContent);
            }
            
            // Render markdown
            textElement.innerHTML = renderMarkdown(processedContent);
            messageElement.appendChild(textElement);
            
            // Add to wrapper
            messageWrapper.appendChild(messageElement);
            
            // Add thinking section if available
            if (message.thinking && message.role === 'assistant') {
                const toggleElement = document.createElement('div');
                toggleElement.className = 'toggle-thinking';
                toggleElement.textContent = 'Show thinking process';
                
                const thinkingElement = document.createElement('div');
                thinkingElement.className = 'thinking';
                thinkingElement.textContent = message.thinking;
                
                toggleElement.addEventListener('click', () => {
                    if (thinkingElement.style.display === 'block') {
                        thinkingElement.style.display = 'none';
                        toggleElement.textContent = 'Show thinking process';
                    } else {
                        thinkingElement.style.display = 'block';
                        toggleElement.textContent = 'Hide thinking process';
                    }
                });
                
                // Show thinking section if the checkbox is checked
                if (showThinking.checked) {
                    thinkingElement.style.display = 'block';
                    toggleElement.textContent = 'Hide thinking process';
                }
                
                messageWrapper.appendChild(toggleElement);
                messageWrapper.appendChild(thinkingElement);
            }
            
            chatContainer.appendChild(messageWrapper);
            
            // Scroll to bottom
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            // Update chat history
            if (!message.temporary) {
                chatHistory.push({
                    role: message.role,
                    content: message.content
                });
            }
        }
        
        // Clean special tokens from assistant responses
        function cleanSpecialTokens(text) {
            if (!text) return "";
            
            // Remove all special tokens by matching various possible variants
            // 1. Chinese-style markers
            text = text.replace(/<｜begin[\s_▁]of[\s_▁]sentence｜>/g, '');
            text = text.replace(/<｜end[\s_▁]of[\s_▁]sentence｜>/g, '');
            text = text.replace(/Ã/g, '');
            text = text.replace(/×/g, '');
            
            // 2. English-style markers (common DeepSeek output format)
            text = text.replace(/<\|begin[\s_]of[\s_]sentence\|>/g, '');
            text = text.replace(/<\|end[\s_]of[\s_]sentence\|>/g, '');
            text = text.replace(/<\|User\|>/g, '');
            text = text.replace(/<\|Assistant\|>/g, '');
            
            // 3. Generic pattern to match markers that may contain spaces or other characters
            text = text.replace(/<\|.*?User.*?\|>/g, '');
            text = text.replace(/<\|.*?Assistant.*?\|>/g, '');
            text = text.replace(/<\|.*?begin.*?of.*?sentence.*?\|>/g, '');
            text = text.replace(/<\|.*?end.*?of.*?sentence.*?\|>/g, '');
            
            // Replace placeholder school names with "NYC School"
            text = text.replace(/所得学校/g, 'NYC School');
            
            return text;
        }
        
        // Render markdown content
        function renderMarkdown(text) {
            if (!text) return "";
            
            // Configure marked options
            marked.setOptions({
                breaks: true,
                gfm: true,
                highlight: function(code, language) {
                    if (language && hljs.getLanguage(language)) {
                        try {
                            return hljs.highlight(code, { language: language }).value;
                        } catch (e) {
                            console.error('Error highlighting code:', e);
                        }
                    }
                    return code;
                }
            });
            
            try {
                // Convert markdown to HTML
                return marked.parse(text);
            } catch (e) {
                console.error('Error rendering markdown:', e);
                return text; // Return plain text if markdown rendering fails
            }
        }
        
        // Send a message
        async function sendMessage() {
            const content = userInput.value.trim();
            
            if (!content) return;
            
            // Disable input and button while sending
            sendButton.disabled = true;
            userInput.disabled = true;
            
            // Add user message to chat
            addMessage({
                role: 'user',
                content: content
            });
            
            // Clear input
            userInput.value = '';
            userInput.style.height = 'auto';
            
            // Add temporary assistant message with loading indicator
            const loadingWrapper = document.createElement('div');
            loadingWrapper.className = 'message-wrapper';
            
            const loadingElement = document.createElement('div');
            loadingElement.className = 'message assistant-message';
            loadingElement.innerHTML = `
                <div class="message-header"><i class="bi bi-robot"></i> Assistant</div>
                <div class="message-text"><span class="loader"></span>Thinking...</div>
            `;
            
            loadingWrapper.appendChild(loadingElement);
            chatContainer.appendChild(loadingWrapper);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            try {
                // Debug output about the NYC Schools RAG retrieval
                console.log("Using NYC Schools Knowledge Base:", useRetrieval.checked);
                
                // Debug output - log request details
                console.log("Sending request to:", CHAT_ENDPOINT);
                console.log("Request payload:", JSON.stringify({
                    messages: chatHistory,
                    use_retrieval: useRetrieval.checked
                }));
                
                // Send request to the API
                const response = await fetch(CHAT_ENDPOINT, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        messages: chatHistory,
                        use_retrieval: useRetrieval.checked
                    })
                });
                
                // Remove loading message
                chatContainer.removeChild(loadingWrapper);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log("Response received:", data);
                    
                    // Fix the response format if needed
                    const assistantResponse = {
                        role: 'assistant',
                        content: data.response || data.content || "",
                        thinking: data.thinking || ""
                    };
                    
                    // Add assistant message to chat
                    addMessage(assistantResponse);
                } else {
                    // Handle API error
                    let errorMessage = 'Something went wrong. Please try again.';
                    try {
                        const errorData = await response.json();
                        errorMessage = errorData.detail || errorMessage;
                        console.error("API error:", errorData);
                    } catch (e) {
                        // If can't parse JSON, use status text
                        errorMessage = response.statusText || errorMessage;
                        console.error("Response error:", response.status, response.statusText);
                    }
                    
                    addMessage({
                        role: 'assistant',
                        content: `Error: ${errorMessage}`
                    });
                }
            } catch (error) {
                // Remove loading message
                chatContainer.removeChild(loadingWrapper);
                
                // Handle network error
                console.error('Error sending message:', error);
                addMessage({
                    role: 'assistant',
                    content: 'Error: Could not connect to the server. Please check your connection and try again.'
                });
            } finally {
                // Re-enable input and button
                sendButton.disabled = false;
                userInput.disabled = false;
                userInput.focus();
            }
        }
        
        // Event listeners
        sendButton.addEventListener('click', sendMessage);
        
        userInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        });
        
        // Toggle debug panel with Ctrl+Shift+D
        document.addEventListener('keydown', (event) => {
            if (event.ctrlKey && event.shiftKey && event.key === 'D') {
                event.preventDefault();
                debugPanel.style.display = debugPanel.style.display === 'none' ? 'block' : 'none';
            }
        });
        
        // Update thinking sections when show-thinking checkbox changes
        showThinking.addEventListener('change', () => {
            const thinkingSections = document.querySelectorAll('.thinking');
            const toggleButtons = document.querySelectorAll('.toggle-thinking');
            
            for (let i = 0; i < thinkingSections.length; i++) {
                if (showThinking.checked) {
                    thinkingSections[i].style.display = 'block';
                    toggleButtons[i].textContent = 'Hide thinking process';
                } else {
                    thinkingSections[i].style.display = 'none';
                    toggleButtons[i].textContent = 'Show thinking process';
                }
            }
        });
        
        // Add auto-resize for textarea
        userInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
        });
        
        // Initialize chat on page load
        window.addEventListener('load', initChat);
    </script>
</body>
</html> 